
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Big data with hadoop stream and ruby (and not even one line of java) - Aurélien Hervé</title>
  <meta name="author" content="A. Hervé">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://aurelien-herve.com/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Aurélien Hervé" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28822787-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Aurélien Hervé</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/publications">Conferences & publications</a></li>
  <li><a href="#" onclick="alert('feel free to drop me a mail ! \n mail @ aurelien-herve.com');">contact</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>




        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:aurelien-herve.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">Big Data With Hadoop Stream and Ruby (and Not Even One Line of Java)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-14T13:42:09+01:00" pubdate data-updated="true">Jan 14<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Objective:</h3>

<p>In this tuto I&rsquo;ll show you how to process billions of data with minimal efforts and code with elastic mapreduce and hadoop-stream. Our list to Santa is :</p>

<ul>
<li>I want to process an unknown amount of data in a scalable, custom way</li>
<li>The same code can be run locally and remotely, so I can debug or process any amount of data without changing anything</li>
<li>I should be able to use any language I like, and this does not especially have to be java. In this example I&rsquo;ll be using ruby because it&rsquo;s awesome. Simply translate this tuto to python, perl, php or anything you want, it&rsquo;ll still work.</li>
</ul>


<!-- more -->


<h2>1. Let&rsquo;s play a game</h2>

<p>Let&rsquo;s suppose we are running a huge gaming platform. As the brand new data scientist, we&rsquo;re asked to perform some simple stats on our users.</p>

<p>For the sake of the example, let&rsquo;s compute any user&rsquo;s average ranking, per type of played games.</p>

<p>From the platform logs we have to kind of files:</p>

<ul>
<li>a <code>GameLog</code> file describes the type of game, the date, and a game id</li>
<li>a <code>PlayerLog</code> file describes how a player scored a game. It contains the game id, the player id, and the player score.</li>
</ul>


<p>This looks like</p>

<figure class='code'><figcaption><span>PlayerLog</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">PlayerId</span>    <span class="no">Score</span>    <span class="no">GameId</span>
</span><span class='line'><span class="mi">1</span>           <span class="mi">1</span>       <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span>           <span class="mi">2</span>       <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span>           <span class="mi">0</span>       <span class="mi">1</span>
</span><span class='line'><span class="mi">2</span>           <span class="mi">5</span>       <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>GameLog</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">GameId</span>    <span class="no">Type</span>
</span><span class='line'><span class="mi">1</span>         <span class="n">chess</span>
</span><span class='line'><span class="mi">2</span>         <span class="n">go</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our files are tab separated (tsv) format, and stored on an amazon <a href="https://aws.amazon.com/s3/">aws s3</a> bucket.</p>

<h4>Expected output:</h4>

<figure class='code'><figcaption><span>Output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Player_id</span>    <span class="no">GameType</span>    <span class="no">AverageRank</span>
</span><span class='line'><span class="mi">1</span>            <span class="n">chess</span>       <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span>            <span class="n">go</span>          <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span>            <span class="n">chess</span>       <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span>            <span class="n">go</span>          <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<h2>2. Do this with style !</h2>

<p>We are going to solve this algorithm with mapreduce. Map/reduce is a programming paradigm that will allow you to <em>horizontally scale</em> the program execution. This means the more parallel servers you get, the more efficient you will be. Obviously within a reasonable range, mounting 300 servers to process 10 lines of data doesn&rsquo;t look like a good idea..</p>

<p>In addition to be scalable, I really find a map/reduce reduces the amount of code, increases claricity, and should thus be used even for moderate amount of datas.</p>

<p><strong>Bonus:</strong> We&rsquo;ll be able to run our code both locally for quick tests, and remotely for heavy processing \o/</p>

<h4>The approach</h4>

<p>Before entering in the details, here is what we are going to do:</p>

<ul>
<li>map the raw data and extract useful information (map)</li>
<li>group the data by <code>game_id</code> key (sort)</li>
<li>compute each player rank for each game (reduce1)</li>
<li>group the data by (player,game_type) couples (sort)</li>
<li>for each (player/game_type) couple, compute the average rank (reduce2)</li>
</ul>


<p>Our steps hence consists in a <em>map &ndash;> reduce &ndash;> reduce</em> procedure. If we think of a second mapper which is identity, then we have two <code>map-&gt;reduce</code> steps</p>

<p>As we plan to use hadoop-stream, the only things we need are three script files that will represent our mapper, and reducers. Each file will consist of a simple script that will &ldquo;eat&rdquo; data via <code>STDIN</code>, and output something to <code>STDOUT</code>.
Again, I&rsquo;m using ruby as an example here. If you&rsquo;re more comfortable with any other language, then please use it, as long as it knows <code>STDIN</code> and <code>STDOUT</code> !</p>

<p>Thanks to Hadoop, we won&rsquo;t have to take care of the sort steps, the data redundency management, the possible server crashes, and plenty of boring stuff. How nice is that ?</p>

<h3>2.1. first mapper</h3>

<p>The first mapper&rsquo;s role will be to &ldquo;eat&rdquo; raw data with absolutely no context, nor any knowledge of what&rsquo;s happening elsewhere (<em>i.e.</em> on other potential workers). It is very important to note that there is absolutely no relation between two consecutive lines that a mapper receives.
For instance, some mapper could receive the first line of the first log, then the 10th line of another log file, then the 2nd line of the first log&hellip;etc</p>

<figure class='code'><figcaption><span>map1.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Mapper</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># initialize a mapper with raw data.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># chomp will remove endline characters</span>
</span><span class='line'>    <span class="c1"># split will split the line for every tab character \t</span>
</span><span class='line'>    <span class="c1"># strip will remove whitespaces at begining and end of every words</span>
</span><span class='line'>    <span class="vi">@data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># this &quot;switch&quot; will determine if we are reading a GameLog or a UserLog line</span>
</span><span class='line'>  <span class="c1"># in our example, it is sufficient to look whether @data has 2, or 3 values</span>
</span><span class='line'>  <span class="c1"># for more complex cases, I&#39;m sure you&#39;ll always find something ;)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">log_type</span>
</span><span class='line'>    <span class="vi">@log_type</span> <span class="o">||=</span> <span class="k">if</span> <span class="vi">@data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>                <span class="ss">:game_log</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                <span class="ss">:player_log</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">game_log_output</span>
</span><span class='line'>    <span class="n">game_id</span>   <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="n">game_type</span> <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span><span class="n">game_id</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">game_type</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">player_log_output</span>
</span><span class='line'>    <span class="n">player_id</span> <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="n">score</span>     <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="n">game_id</span>   <span class="o">=</span> <span class="vi">@data</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span><span class="n">game_id</span><span class="p">,</span> <span class="n">log_type</span><span class="p">,</span> <span class="n">player_id</span><span class="p">,</span> <span class="n">score</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># the mapper result</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">output</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">game_log_output</span> <span class="k">if</span> <span class="n">log_type</span> <span class="o">==</span> <span class="ss">:game_log</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">player_log_output</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># the Map! class method</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">map!</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="no">Mapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">ARGF</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="no">Mapper</span><span class="o">.</span><span class="n">map!</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">unless</span> <span class="n">line</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">empty?</span> <span class="c1"># map every non-empty line with our mapper</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this mapper will always output the <code>game_id</code> as first key. Then, regarding of the log type, it will either output informations about the player, or the game.</p>

<p>You can run locally your mapper by simply running <code>cat datain/* | map1.rb</code>, whitch outputs something like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span> <span class="n">player_log</span>  <span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">2</span> <span class="n">player_log</span>  <span class="mi">1</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span> <span class="n">player_log</span>  <span class="mi">2</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">2</span> <span class="n">player_log</span>  <span class="mi">2</span> <span class="mi">5</span>
</span><span class='line'><span class="mi">1</span> <span class="n">game_log</span>  <span class="n">chess</span>
</span><span class='line'><span class="mi">2</span> <span class="n">game_log</span>  <span class="n">go</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.2 first sort</h3>

<p>I feel like this step should be explained even if it does not require any work. What will be happening here is that hadoop will take care of our first outputed results.
By default, it will split using the <code>tab</code> character, and will assign a single reducer instance for each key.
Furthermore, it will garanty that a reducer will see &lsquo;sorted&rsquo; results</p>

<p>This step is very important to understand. It means two things for the reducer:</p>

<ul>
<li>For each primary key (<code>game_id</code> in our example), all the corresponding lines will be sent to the same reducer instance. This allows to process data without any communication between the reducers.</li>
<li>The data is sorted. This implies that if a reducer sees a <code>game_id=1</code> key, then all following lines will also be <code>game_id=1</code> until there is no <code>game_id=1</code> key left. Ever. As soon a the reducer receives a different primary key, then we can assume <strong>all</strong> the <code>game_id=1</code> lines have been processed.</li>
</ul>


<h4>When running with bash:</h4>

<p>As I said, I should be able to run my code both locally and remotely. Fortunately, we can perform a sort with bash with the <code>sort</code> command.</p>

<p>This trick consists of performing a pure sort on the data. When running locally, we don&rsquo;t have to distribute the data between different instances (which hadoop does) so a sorted data will garanty the two features that we require for our reducer.</p>

<p>running this in bash would yield:</p>

<p><code>cat datain/* | map1.rb | sort</code> =></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span> <span class="n">game_log</span>  <span class="n">chess</span>
</span><span class='line'><span class="mi">1</span> <span class="n">player_log</span>  <span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="mi">1</span> <span class="n">player_log</span>  <span class="mi">2</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">2</span> <span class="n">game_log</span>  <span class="n">go</span>
</span><span class='line'><span class="mi">2</span> <span class="n">player_log</span>  <span class="mi">1</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">2</span> <span class="n">player_log</span>  <span class="mi">2</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the data is now grouped by <code>game_id</code> key. How delightful.</p>

<h4>When running with hadoop:</h4>

<p>Simply perform some cool dance moves while hadoop take care of everything.</p>

<p><img class="center" src="/images/success_dance.gif"></p>

<h3>2.3 first reduce</h3>

<p>The first reducer will accumulate the player scores, in order to determine the players ranks in each played game:</p>

<figure class='code'><figcaption><span>reduce1.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Reducer</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:key</span><span class="p">,</span> <span class="ss">:game_type</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@key</span> <span class="o">=</span> <span class="n">key</span>
</span><span class='line'>    <span class="vi">@player_scores</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="n">splitted_line</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">splitted_line</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;game_log&#39;</span> <span class="c1">#if the line is of type game_log</span>
</span><span class='line'>      <span class="vi">@game_type</span> <span class="o">=</span> <span class="n">splitted_line</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span> <span class="c1"># if the line is of type player_log</span>
</span><span class='line'>      <span class="n">player_id</span> <span class="o">=</span> <span class="n">splitted_line</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>      <span class="n">player_score</span> <span class="o">=</span> <span class="n">splitted_line</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@player_scores</span><span class="o">[</span><span class="n">player_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">player_score</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">output!</span>
</span><span class='line'>    <span class="n">ordered_player_ids</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="nb">id</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@game_type</span><span class="si">}</span><span class="s2">|</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1"># joined to form a new key for the next reducer</span>
</span><span class='line'>        <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#the rank (+1 so the first has a rank of 1)</span>
</span><span class='line'>      <span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">ordered_player_ids</span>
</span><span class='line'>    <span class="c1"># this will output a list of player_ids, sorted by their scores</span>
</span><span class='line'>    <span class="c1"># Note that I&#39;m way too lazy to deal with draws here :D</span>
</span><span class='line'>    <span class="vi">@player_scores</span><span class="o">.</span><span class="n">sort_by</span><span class="p">{</span><span class="o">|</span><span class="n">player</span><span class="p">,</span><span class="n">score</span><span class="o">|</span> <span class="n">score</span><span class="p">}</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">ARGF</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># split the data</span>
</span><span class='line'>  <span class="n">splitted_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># get the primary key</span>
</span><span class='line'>  <span class="n">new_key</span> <span class="o">=</span> <span class="n">splitted_line</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#initialize if required</span>
</span><span class='line'>  <span class="vi">@red</span> <span class="o">||=</span> <span class="no">Reducer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># if the key is the same, then continue accumulating</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">new_key</span> <span class="o">==</span> <span class="vi">@red</span><span class="o">.</span><span class="n">key</span>
</span><span class='line'>    <span class="vi">@red</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">splitted_line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># if the key is new, then first output current results, then instanciate a new reducer</span>
</span><span class='line'>    <span class="c1"># Note that once the result is outputed to STDOUT, we can drop the reducer instance</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@red</span><span class="o">.</span><span class="n">output!</span> <span class="k">unless</span> <span class="vi">@red</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>    <span class="vi">@red</span> <span class="o">=</span> <span class="no">Reducer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@red</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">splitted_line</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="vi">@red</span><span class="o">.</span><span class="n">output!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our process yield <code>cat datain.dat | ./map1.rb | sort | ./reduce1.rb</code> =></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">2</span> <span class="mi">2</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">2</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">2</span>    <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>This could be read as</p>

<ul>
<li><em>player 1 scored one chess game with rank 1</em></li>
<li><em>player 2 scored one chess game with rank 2</em></li>
<li><em>player 1 scored one go game with rank 2</em></li>
<li><em>player 2 scored one go game with rank 1</em></li>
</ul>


<p>Please note something very important here: <strong>The reducer stores almost nothing in memory!</strong>
As you can see in the script, as soon as a game is finished processing, then we can simply output the result and drop our reducer. Nothing has to stay in memory, so you don&rsquo;t need any ram on your workers, even to process billions of games !</p>

<h3>2.4. coffe break !</h3>

<p><img class="center" src="/images/coffe-break.gif"></p>

<p>If you&rsquo;re still reading this then I&rsquo;m sure you deserve it.</p>

<h3>2.5. Second mapper</h3>

<p>Nothing has to be done here, the data is already formated for the next reduce step.</p>

<p>Conceptualy, we can view this step as a map step, where the mapper would be identity.
As a reminder that something is still hapening here, I&rsquo;ll pipe the unix <code>cat</code> command to our workflow. Of course it has no practical purpose.</p>

<p>When running our code with hadoop-stream, we&rsquo;ll declare a <code>map</code> step, with identity mapper ( or we&rsquo;ll simply declare <code>cat</code> to be our mapper script, which is pretty much the same)</p>

<h3>2.6 Last step: averaging the scores</h3>

<p>For the sake of the argument, let&rsquo;s say I wasn&rsquo;t this lazy, and generated much more data, which led to a <code>reduce1</code> output that reads</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">2</span> <span class="mi">1</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">2</span> <span class="mi">2</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">2</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">1</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">1</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">2</span> <span class="mi">2</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">1</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">1</span>    <span class="mi">2</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">1</span> <span class="mi">8</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">2</span>    <span class="mi">1</span>
</span><span class='line'><span class="n">go</span><span class="o">|</span><span class="mi">2</span>    <span class="mi">1</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">3</span> <span class="mi">2</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">1</span> <span class="mi">8</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">1</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">1</span> <span class="mi">8</span>
</span><span class='line'><span class="n">chess</span><span class="o">|</span><span class="mi">1</span> <span class="mi">2</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">3</span> <span class="mi">5</span>
</span><span class='line'><span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span><span class="o">|</span><span class="mi">3</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>We now have three players, three different games. I also shuffled the results, to emphasis that the reduce step does not necessary provide sorted results.
Actually it does when running our <em>bash workflow</em>, since we&rsquo;re using <code>sort</code> and a single proc. Generally speaking it is not.</p>

<p>Once we run the identity mapper, followed by the sort step, it will again be sorted so we can write our final reducer as follows:</p>

<figure class='code'><figcaption><span>reduce2.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Reducer</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:key</span><span class="p">,</span> <span class="ss">:game_type</span><span class="p">,</span> <span class="ss">:user_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@key</span> <span class="o">=</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#split the primary key to get user_id and game type:</span>
</span><span class='line'>    <span class="vi">@game_type</span><span class="p">,</span><span class="vi">@user_id</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#to perform an on-the-fly average, we only need two variables:</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="vi">@average</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">to_f</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#on the fly averaging. We do NOT store the entire array !</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">accumulate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@average</span>  <span class="o">=</span> <span class="p">(</span> <span class="vi">@count</span><span class="o">.</span><span class="n">to_f</span><span class="o">/</span><span class="p">(</span><span class="vi">@count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="vi">@average</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_f</span> <span class="o">/</span> <span class="p">(</span><span class="vi">@count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># follow the expectations</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">output!</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="o">[</span>
</span><span class='line'>      <span class="vi">@user_id</span><span class="p">,</span>
</span><span class='line'>      <span class="vi">@game_type</span><span class="p">,</span>
</span><span class='line'>      <span class="vi">@average</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">ARGF</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="k">next</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># split the data</span>
</span><span class='line'>  <span class="n">new_key</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#initialize if required</span>
</span><span class='line'>  <span class="vi">@red</span> <span class="o">||=</span> <span class="no">Reducer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># if the key is the same, then continue accumulating</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">new_key</span> <span class="o">==</span> <span class="vi">@red</span><span class="o">.</span><span class="n">key</span>
</span><span class='line'>    <span class="vi">@red</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># if the key is new, then first output current results, then instanciate a new reducer</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@red</span><span class="o">.</span><span class="n">output!</span>
</span><span class='line'>    <span class="vi">@red</span> <span class="o">=</span> <span class="no">Reducer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="vi">@red</span><span class="o">.</span><span class="n">output!</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we run our bash process we get <code>cat datain/* | ./map1.rb | sort | ./reduce1.rb | cat | sort | ./reduce2.rb</code> (assuming we have our new dataset):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span> <span class="n">chess</span> <span class="mi">1</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'><span class="mi">2</span> <span class="n">chess</span> <span class="mi">1</span><span class="o">.</span><span class="mi">7</span>
</span><span class='line'><span class="mi">1</span> <span class="n">go</span>  <span class="mi">1</span><span class="o">.</span><span class="mi">4</span>
</span><span class='line'><span class="mi">2</span> <span class="n">go</span>  <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="mi">1</span> <span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="mi">3</span> <span class="n">hide</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">seek</span> <span class="mi">2</span><span class="o">.</span><span class="mi">7</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it ! we know knows that the player 1 performed an average rank of 1.2 at chess, and an average rank of 8.0 at hide and seek !</p>

<h2>3. Going heavy</h2>

<p>Like I told you, our script are hadoop-ready. Provided you have an aws-amazon account, running our code can be done very easily:</p>

<ul>
<li>install amazon elastic-mapreduce client and configure it (basically give it your credentials)</li>
<li>run the first map-reduce stage:</li>
</ul>


<figure class='code'><figcaption><span>elastic_mapreduce_launcher_stage1.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>elastic-mapreduce <span class="se">\</span>
</span><span class='line'>  --create <span class="se">\</span>
</span><span class='line'>  --name look_mom_big_data <span class="se">\</span>
</span><span class='line'>  --stream <span class="se">\</span>
</span><span class='line'>  --input s3n://yourbucket/data_in <span class="se">\</span>
</span><span class='line'>  --mapper s3n://yourbucket/src/map1.rb <span class="se">\</span>
</span><span class='line'>  --reducer s3n://yourbucket/src/reduce1.rb <span class="se">\</span>
</span><span class='line'>  --output s3n://yourbucket/first_results <span class="se">\</span>
</span><span class='line'>  --log-uri s3://yourbucket/emr-logs/ <span class="se">\</span>
</span><span class='line'>  --region eu-west-1 <span class="se">\</span>
</span><span class='line'>  --instance-type m1.small <span class="se">\</span>
</span><span class='line'>  --num-instances 300
</span></code></pre></td></tr></table></div></figure>


<p>then</p>

<figure class='code'><figcaption><span>elastic_mapreduce_launcher2.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>elastic-mapreduce <span class="se">\</span>
</span><span class='line'>  --create <span class="se">\</span>
</span><span class='line'>  --name look_mom_big_data <span class="se">\</span>
</span><span class='line'>  --stream <span class="se">\</span>
</span><span class='line'>  --input s3n://yourbucket/first_results <span class="se">\</span>
</span><span class='line'>  --mapper cat <span class="se">\</span>
</span><span class='line'>  --reducer s3n://yourbucket/src/reduce2.rb <span class="se">\</span>
</span><span class='line'>  --output s3n://yourbucket/output <span class="se">\</span>
</span><span class='line'>  --log-uri s3://yourbucket/emr-logs/ <span class="se">\</span>
</span><span class='line'>  --region eu-west-1 <span class="se">\</span>
</span><span class='line'>  --instance-type m1.small <span class="se">\</span>
</span><span class='line'>  --num-instances 300
</span></code></pre></td></tr></table></div></figure>


<p>Note that I&rsquo;m using two different launchers here. You can also tell your launcher to perform multiple steps by passing them as json. See the elastic-mapreduce doc for that.</p>

<p><em>Wait&hellip; Is it this simple?</em></p>

<p>Yes. This simple.</p>

<h2>Conclusion</h2>

<p>Thanks for reading, you&rsquo;re awesome</p>

<p><img class="center" src="/images/not_impressed.gif"></p>

<p>If this helped you in any way, feel free to drop a comment, correct something, ask a question, or simply let me know this was interesting, thanks !</p>

<p>Please note that this approach can be &mdash; and have been &mdash; used for heavy industrial purposes. You can litterally process billions of rows in no time, with a few lines of code. This is, in my opinion, a tremendous way to prototype and scale your data analysis !</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">A. Hervé</span></span>

      








  


<time datetime="2015-01-14T13:42:09+01:00" pubdate data-updated="true">Jan 14<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/big-data/'>big data</a>, <a class='category' href='/blog/categories/elastic-mapreduce/'>elastic mapreduce</a>, <a class='category' href='/blog/categories/hadoop/'>hadoop</a>, <a class='category' href='/blog/categories/mapreduce/'>mapreduce</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/tutorial/'>tutorial</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://aurelien-herve.com/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby/" data-via="aurel_herve" data-counturl="http://aurelien-herve.com/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/blog/2014/10/14/advanced-api-option-parser-for-grape/" title="Previous Post:
        Building an advanced api option parser for grape">&laquo; Building an advanced api option parser for grape</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" href="/blog/2015/01/16/building-a-recommendation-engine-with-ruby/"
        title="Next Post: building a recommendation engine with ruby">building a recommendation engine with ruby
        &raquo;</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2015/01/16/building-a-recommendation-engine-with-ruby/">building a recommendation engine with ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby/">Big data with hadoop stream and ruby (and not even one line of java)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/14/advanced-api-option-parser-for-grape/">Building an advanced api option parser for grape</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/how-to-migrate-your-django-users-to-a-new-rails-application/">how to migrate your django users to a new rails application</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/27/some-cool-functional-programming-with-ruby/">Having fun with functional programming in ruby</a>
      </li>
    
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub Repos</li>
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/aherve">@aherve</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'aherve',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>

<a class="twitter-timeline" href="https://twitter.com/aurel_herve" data-widget-id="439334447087747072">Tweets by @aurel_herve</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2015 - A. Hervé -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'aherve';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://aurelien-herve.com/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby/';
        var disqus_url = 'http://aurelien-herve.com/blog/2015/01/14/big-data-with-hadoop-stream-and-ruby/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
